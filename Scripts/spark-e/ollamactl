#!/usr/bin/env bash
set -euo pipefail

NAME="open-webui"
IMAGE="ghcr.io/open-webui/open-webui:ollama"

usage() {
  cat <<EOF
Usage: $(basename "$0") <command>

Commands:
  start   Start Ollama + OpenWebUI (create container if needed)
  stop    Stop the container
  update  Pull the latest image and restart the container
  status  Show running state of the container
  list    List available Ollama models
EOF
  exit 1
}

# Ensure Docker CLI and daemon are available
if ! docker info >/dev/null 2>&1; then
  echo "Error: Docker daemon not reachable." >&2
  exit 1
fi

cmd="${1:-}"
[[ -z "$cmd" ]] && usage

case "$cmd" in
  start)
    if [ -n "$(docker ps -q --filter "name=^${NAME}$" --filter "status=running")" ]; then
      echo "Container ${NAME} is already running."
    elif [ -n "$(docker ps -aq --filter "name=^${NAME}$")" ]; then
      echo "Starting existing container ${NAME}..."
      docker start "${NAME}" >/dev/null
      echo "Started."
    else
      echo "Creating and starting ${NAME}..."
      docker run -d \
        -p 12000:8080 \
        -p 11434:11434 \
        --gpus=all \
        -v open-webui:/app/backend/data \
        -v open-webui-ollama:/root/.ollama \
        -e OLLAMA_HOST=0.0.0.0:11434 \
        --name "${NAME}" \
        "${IMAGE}" >/dev/null
      echo "Started."
    fi
    ;;

  stop)
    if [ -n "$(docker ps -q --filter "name=^${NAME}$" --filter "status=running")" ]; then
      echo "Stopping ${NAME}..."
      docker stop "${NAME}" >/dev/null
      echo "Stopped."
    else
      echo "Container ${NAME} is not running."
    fi
    ;;

  update)
    echo "Pulling latest image: ${IMAGE}..."
    docker pull "${IMAGE}"
    if [ -n "$(docker ps -q --filter "name=^${NAME}$" --filter "status=running")" ]; then
      echo "Stopping ${NAME}..."
      docker stop "${NAME}" >/dev/null
    fi
    if [ -n "$(docker ps -aq --filter "name=^${NAME}$")" ]; then
      echo "Removing old container..."
      docker rm "${NAME}" >/dev/null
    fi
    echo "Starting updated container..."
    docker run -d \
      -p 12000:8080 \
      -p 11434:11434 \
      --gpus=all \
      -v open-webui:/app/backend/data \
      -v open-webui-ollama:/root/.ollama \
      -e OLLAMA_HOST=0.0.0.0:11434 \
      --name "${NAME}" \
      "${IMAGE}" >/dev/null
    echo "Update complete."
    ;;

  status)
    running="$(docker ps -q --filter "name=^${NAME}$" --filter "status=running")"
    if [ -n "$running" ]; then
      echo "  ollama    : running  (port 11434)"
      echo "  open-webui: running  (port 12000)"
    else
      stopped="$(docker ps -aq --filter "name=^${NAME}$")"
      if [ -n "$stopped" ]; then
        echo "  ${NAME}: stopped"
      else
        echo "  ${NAME}: not found"
      fi
    fi
    ;;

  list)
    if [ -z "$(docker ps -q --filter "name=^${NAME}$" --filter "status=running")" ]; then
      echo "Error: Container ${NAME} is not running." >&2
      exit 1
    fi
    docker exec "${NAME}" ollama list
    ;;

  *)
    echo "Error: Unknown command '${cmd}'" >&2
    usage
    ;;
esac
